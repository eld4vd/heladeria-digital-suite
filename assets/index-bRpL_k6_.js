import{u as z,a as M,j as e,b as T}from"./tanstack-vendor-C2OWrVrE.js";import{r as i}from"./react-vendor-DKUHWr44.js";import{v as B}from"./venta.service-Di-C3NN7.js";import{z as x}from"./ui-vendor-DZ4uu1AI.js";import{G as I,s as Z,H as $,I as F,p as W}from"./index-C2mWQiVa.js";const U={async getDetalles(){return I.get("/detalles-ventas")},async getDetalle(r){return I.get(`/detalles-ventas/${r}`)},async createDetalle(r){const l={ventaId:Number(r.ventaId),productoId:Number(r.productoId),cantidad:Number(r.cantidad),precioUnitario:Number(Number(r.precioUnitario).toFixed(2)),subtotal:Number(Number(r.subtotal).toFixed(2))};return I.post("/detalles-ventas",l)},async updateDetalle(r,l){const p={...l,ventaId:l.ventaId===void 0?void 0:Number(l.ventaId),productoId:l.productoId===void 0?void 0:Number(l.productoId),cantidad:l.cantidad===void 0?void 0:Number(l.cantidad),precioUnitario:l.precioUnitario===void 0?void 0:Number(Number(l.precioUnitario).toFixed(2)),subtotal:l.subtotal===void 0?void 0:Number(Number(l.subtotal).toFixed(2))};return I.patch(`/detalles-ventas/${r}`,p)},async deleteDetalle(r){await I.delete(`/detalles-ventas/${r}`)}},ee=[{value:"efectivo",label:"Efectivo"},{value:"tarjeta",label:"Tarjeta"},{value:"transferencia",label:"Transferencia"},{value:"qr",label:"QR"}],te=({abierto:r,onCerrar:l})=>{const p=z(),{user:b,empleado:n}=Z(),[c,h]=i.useState(n?$(n):b),[y,u]=i.useState(!0),[j,N]=i.useState(""),[k,v]=i.useState("efectivo"),[w,S]=i.useState(""),[g,d]=i.useState(""),[m,t]=i.useState([]),s=i.useMemo(()=>m.reduce((a,o)=>a+Number(o.subtotal||0),0),[m]),[C,P]=i.useState(!1),[E,D]=i.useState(null),G=()=>`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,_=a=>t(o=>o.filter(f=>f.id!==a)),Y=a=>D(a);i.useEffect(()=>{if(!r)return;N(""),v("efectivo"),S(""),t([]);const a=new Date,o=A=>A.toString().padStart(2,"0"),f=`${a.getFullYear()}-${o(a.getMonth()+1)}-${o(a.getDate())}T${o(a.getHours())}:${o(a.getMinutes())}`;d(f),h(n?$(n):b),u(!0),I.getProfile().then(({user:A})=>{h($(A))}).catch(()=>{h(n?$(n):b??null)}).finally(()=>u(!1))},[r,n,b]);const L=M({mutationFn:a=>B.createVenta(a),onSuccess:async a=>{if(m.length>0&&a?.id)try{await Promise.all(m.map(async o=>{await U.createDetalle({ventaId:Number(a.id),productoId:o.productoId,cantidad:o.cantidad,precioUnitario:Number(o.precioUnitario.toFixed(2)),subtotal:Number(o.subtotal.toFixed(2))})}))}catch(o){if(F(o)&&o.status===409){const f=o.json??null;if((typeof f?.code=="string"?f.code:void 0)==="stock_insuficiente"){const V=K=>{if(!f||!(K in f))return"N/D";const q=f[K];return typeof q=="number"?q.toString():typeof q=="string"?q:"N/D"};x.error(`Stock insuficiente: disponible ${V("disponible")}, solicitado ${V("solicitado")}`);return}}x.error('Venta creada, pero algunos detalles fallaron. Puedes añadirlos luego en "Ver detalles".')}p.invalidateQueries({queryKey:["ventas"]}),p.invalidateQueries({queryKey:["detalles-ventas","venta",a?.id]}),p.invalidateQueries({queryKey:["productos"]}),p.invalidateQueries({predicate:({queryKey:o})=>Array.isArray(o)&&o[0]==="reportes"}),l(),x.success("Venta registrada")},onError:a=>{const o="Error al registrar venta";if(F(a)){x.error(`${o}: ${a.message}`);return}if(a instanceof Error){x.error(`${o}: ${a.message}`);return}x.error(`${o}: desconocido`)}}),J=()=>c?.id?m.length===0?"Agrega al menos un detalle para calcular el total":k?j.length>100?"El nombre del cliente excede 100 caracteres":"":"Selecciona un método de pago":"No se pudo obtener el empleado autenticado",X=a=>{a.preventDefault();const o=J();if(o)return x.error(o);const f=Number(s.toFixed(2)),A=g?new Date(g).toISOString():void 0,V={empleadoId:c.id,clienteNombre:j?j.trim():null,metodoPago:k,total:f,notas:w?w.trim():null,fechaVenta:A||null};L.mutate(V)};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-3xl shadow-xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b sticky top-0 bg-white z-10",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Registrar venta"}),e.jsx("button",{onClick:l,className:"text-gray-500 hover:text-gray-700 text-2xl","aria-label":"Cerrar",children:"×"})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-1",children:e.jsxs("form",{id:"form-venta",onSubmit:X,className:"grid grid-cols-1 gap-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Empleado"}),e.jsx("input",{value:c?c.nombre||b?.nombre||"Empleado":y?"Cargando...":"No disponible",readOnly:!0,className:"w-full px-3 py-2 border rounded-md bg-gray-50 text-gray-700"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Total (calculado)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.toFixed(2),readOnly:!0,className:"w-full px-3 py-2 border rounded-md bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Método de pago *"}),e.jsx("select",{value:k,onChange:a=>v(a.target.value),className:"w-full px-3 py-2 border rounded-md bg-white",required:!0,children:ee.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cliente (opcional)"}),e.jsx("input",{value:j,onChange:a=>N(a.target.value),className:"w-full px-3 py-2 border rounded-md",placeholder:"Nombre del cliente",maxLength:100})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fecha de la venta"}),e.jsx("input",{type:"datetime-local",value:g,readOnly:!0,tabIndex:-1,"aria-readonly":!0,className:"w-full px-3 py-2 border rounded-md bg-gray-50 text-gray-700 cursor-not-allowed pointer-events-none select-none"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Se establece automáticamente y se muestra solo como referencia."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notas"}),e.jsx("textarea",{value:w,onChange:a=>S(a.target.value),rows:3,className:"w-full px-3 py-2 border rounded-md",placeholder:"Observaciones adicionales (opcional)"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold",children:"Detalles de la venta"}),e.jsx("button",{type:"button",onClick:()=>P(!0),className:"px-3 py-1.5 text-sm rounded-md border bg-white hover:bg-gray-50",children:"+ Agregar helado"})]}),m.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Aún no agregaste detalles. Agrega al menos uno para calcular el total."}):e.jsx("div",{className:"overflow-auto rounded border",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Producto"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Cantidad"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Precio"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Subtotal"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Acciones"})]})}),e.jsx("tbody",{children:m.map(a=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.productoImagenUrl?e.jsx("img",{src:a.productoImagenUrl,alt:a.productoNombre,className:"h-10 w-10 rounded object-cover"}):e.jsx("div",{className:"h-10 w-10 rounded bg-gray-100 flex items-center justify-center text-gray-400 text-xs",children:"No img"}),e.jsx("span",{children:a.productoNombre})]})}),e.jsx("td",{className:"px-3 py-2 text-right",children:a.cantidad}),e.jsx("td",{className:"px-3 py-2 text-right",children:Number(a.precioUnitario).toFixed(2)}),e.jsx("td",{className:"px-3 py-2 text-right font-semibold",children:Number(a.subtotal).toFixed(2)}),e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("button",{type:"button",onClick:()=>Y(a),className:"px-2 py-1 text-xs rounded border bg-white hover:bg-gray-50 mr-2",children:"Editar"}),e.jsx("button",{type:"button",onClick:()=>_(a.id),className:"px-2 py-1 text-xs rounded border border-red-300 text-red-700 hover:bg-red-50",children:"Quitar"})]})]},a.id))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 font-medium",colSpan:3,children:"Total"}),e.jsx("td",{className:"px-3 py-2 text-right font-semibold",children:s.toFixed(2)}),e.jsx("td",{})]})})]})})]})]})}),e.jsxs("div",{className:"px-6 py-4 border-t sticky bottom-0 bg-white z-10 flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:l,className:"px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200",children:"Cancelar"}),e.jsx("button",{type:"submit",form:"form-venta",disabled:L.isPending||y||!c?.id||m.length===0,className:"px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-60",children:L.isPending?"Guardando...":"Guardar"})]})]})}),e.jsx(se,{abierto:C||!!E,onCerrar:()=>{P(!1),D(null)},onSave:a=>{if(E)t(o=>o.map(f=>f.id===E.id?{...f,...a,subtotal:Number(a.subtotal.toFixed(2))}:f)),D(null);else{const o=m.find(f=>f.productoId===a.productoId);if(o){x.error('Este producto ya está en la lista. Usa "Editar" para cambiar la cantidad.'),D(o),P(!1);return}t(f=>[...f,{id:G(),productoId:a.productoId,productoNombre:a.productoNombre,productoImagenUrl:a.productoImagenUrl,precioUnitario:a.precioUnitario,cantidad:a.cantidad,subtotal:a.subtotal}]),P(!1)}},inicial:E?{productoId:E.productoId,precioUnitario:E.precioUnitario,cantidad:E.cantidad}:void 0})]}):null};function se({abierto:r,onCerrar:l,onSave:p,inicial:b}){const{data:n}=T({queryKey:["productos"],queryFn:W.getProductos,staleTime:12e4,refetchOnWindowFocus:!1}),[c,h]=i.useState(b?.productoId||(n?.[0]?.id??0)),y=i.useMemo(()=>{const d=(n||[]).find(m=>m.id===c);return Number(d?.precio||0)},[n,c]),[u,j]=i.useState(b?.cantidad||1),[N,k]=i.useState(b?.precioUnitario??y);i.useEffect(()=>{k(y)},[y]);const v=i.useMemo(()=>Number(((N||0)*(u||0)).toFixed(2)),[N,u]),w=()=>{if(!c)return"Producto inválido";if(!u||u<1||!Number.isInteger(Number(u)))return"Cantidad debe ser entero >= 1";if(N<0)return"Precio no puede ser negativo";const d=(n||[]).find(m=>m.id===c);return d&&Number(u)>Number(d.stock)?`Cantidad supera el stock disponible (${d.stock})`:""},S=d=>{d.preventDefault();const m=w();if(m)return x.error(m);const t=(n||[]).find(s=>s.id===c);p({productoId:c,productoNombre:t?.nombre||"Producto",productoImagenUrl:t?.imagenUrl??null,precioUnitario:Number(N.toFixed(2)),cantidad:Number(u),subtotal:Number(v.toFixed(2))})};if(!r)return null;const g=(n||[]).find(d=>d.id===c);return e.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg shadow-xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b sticky top-0 bg-white z-10",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Agregar helado"}),e.jsx("button",{onClick:l,className:"text-gray-500 hover:text-gray-700 text-2xl","aria-label":"Cerrar",children:"×"})]}),e.jsxs("form",{onSubmit:S,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Producto"}),e.jsx("select",{value:c,onChange:d=>h(Number(d.target.value)),className:"w-full px-3 py-2 border rounded-md bg-white",children:(n||[]).map(d=>e.jsx("option",{value:d.id,children:d.nombre},d.id))}),g?.imagenUrl&&e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("img",{src:g.imagenUrl,alt:g.nombre,className:"h-14 w-14 rounded object-cover"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Vista previa"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cantidad"}),e.jsx("input",{type:"number",min:1,step:1,value:u,onChange:d=>j(Number(d.target.value)),className:"w-full px-3 py-2 border rounded-md"}),g&&e.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Stock disponible: ",g.stock]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio unitario"}),e.jsx("input",{type:"text",value:N,readOnly:!0,tabIndex:-1,"aria-readonly":!0,className:"w-full px-3 py-2 border rounded-md bg-gray-50 text-gray-700 cursor-not-allowed pointer-events-none select-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subtotal"}),e.jsx("input",{readOnly:!0,disabled:!0,value:v,className:"w-full px-3 py-2 border rounded-md bg-gray-50 text-gray-700 cursor-not-allowed pointer-events-none select-none"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:l,className:"px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",children:"Agregar"})]})]})]})})}const Q=r=>new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(typeof r=="string"?Number(r):r);function ae({ventaId:r,ventaInfo:l,abierto:p,onCerrar:b}){const n=z(),[c,h]=i.useState(!1),[y,u]=i.useState(null),{data:j,isLoading:N,error:k,refetch:v,isFetching:w}=T({queryKey:["detalles-ventas","venta",r],queryFn:async()=>(await U.getDetalles()).filter(C=>C.ventaId===r),staleTime:6e4,refetchOnWindowFocus:!1,enabled:p}),S=i.useMemo(()=>(j||[]).reduce((s,C)=>s+(Number(C.subtotal)||0),0),[j]),g=i.useRef(null),d=M({mutationFn:s=>B.updateVenta(r,{total:O(s)}),onSuccess:()=>{n.invalidateQueries({queryKey:["ventas"]}),n.invalidateQueries({predicate:({queryKey:s})=>Array.isArray(s)&&s[0]==="reportes"})}});i.useEffect(()=>{if(!p||j==null)return;const s=O(S);if(g.current===null){g.current=s;return}g.current!==s&&(g.current=s,d.mutate(s))},[p,j,S,d]);const m=()=>{n.invalidateQueries({queryKey:["detalles-ventas","venta",r]}),n.invalidateQueries({queryKey:["ventas"]}),n.invalidateQueries({queryKey:["productos"]}),n.invalidateQueries({predicate:({queryKey:s})=>Array.isArray(s)&&s[0]==="reportes"})},t=M({mutationFn:async s=>{await U.deleteDetalle(s)},onSuccess:()=>{m(),x.success("Detalle eliminado")},onError:s=>{if(F(s)){x.error(s.message||"Error al eliminar");return}if(s instanceof Error){x.error(s.message);return}x.error("Error al eliminar")}});return p?e.jsxs("div",{className:"fixed inset-0 z-[60] flex",children:[e.jsx("div",{className:"flex-1 bg-black/40",onClick:b}),e.jsxs("div",{className:"w-full max-w-3xl h-full bg-white shadow-xl border-l flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Detalles de la venta"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[l?.fecha?new Date(l.fecha).toLocaleString("es-BO"):"-"," | ",l?.cliente||"-"," | ",l?.metodo||"-"," | Total: ",Q(S)]})]}),e.jsx("button",{onClick:b,className:"text-2xl text-gray-500 hover:text-gray-700","aria-label":"Cerrar",children:"×"})]}),e.jsxs("div",{className:"p-4 flex items-center gap-3 border-b",children:[e.jsx("button",{onClick:()=>h(!0),className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"+ Agregar detalle"}),e.jsx("button",{onClick:()=>v(),disabled:w,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700",children:w?"Actualizando...":"Refrescar"}),e.jsxs("div",{className:"ml-auto text-sm text-gray-700",children:["Total líneas: ",e.jsx("span",{className:"font-semibold",children:Q(S)})]})]}),e.jsxs("div",{className:"p-4 overflow-auto",children:[N?e.jsx("div",{children:"Cargando detalles..."}):k?e.jsxs("div",{className:"text-red-600",children:["Error: ",k.message]}):e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold text-gray-600",children:"#"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold text-gray-600",children:"Producto"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-semibold text-gray-600",children:"Cantidad"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-semibold text-gray-600",children:"Precio"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-semibold text-gray-600",children:"Subtotal"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-semibold text-gray-600",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:(j||[]).map((s,C)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-sm text-gray-600",children:C+1}),e.jsxs("td",{className:"px-4 py-2 text-sm text-gray-800 flex items-center gap-3",children:[s.producto?.imagenUrl?e.jsx("img",{src:s.producto.imagenUrl,alt:s.producto?.nombre||"",className:"w-10 h-10 rounded object-cover border"}):e.jsx("div",{className:"w-10 h-10 rounded bg-gray-100 border"}),e.jsx("div",{children:e.jsx("div",{className:"font-medium",children:s.producto?.nombre||"Producto"})})]}),e.jsx("td",{className:"px-4 py-2 text-sm text-right",children:s.cantidad}),e.jsx("td",{className:"px-4 py-2 text-sm text-right",children:Q(s.precioUnitario)}),e.jsx("td",{className:"px-4 py-2 text-sm text-right font-semibold",children:Q(s.subtotal)}),e.jsx("td",{className:"px-4 py-2 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(s),className:"px-3 py-1.5 text-xs rounded-md border bg-white hover:bg-gray-50",children:"Editar"}),e.jsx("button",{onClick:()=>t.mutate(s.id),disabled:t.isPending,className:"px-3 py-1.5 text-xs rounded-md border border-red-300 text-red-700 hover:bg-red-50",children:t.isPending?"Eliminando...":"Eliminar"})]})})]},s.id))})]}),(j||[]).length===0&&!N&&!k&&e.jsx("div",{className:"text-center text-gray-600 py-8",children:"Sin detalles aún. Agrega el primero."})]}),c&&e.jsx(R,{ventaId:r,onClose:()=>h(!1),onSaved:()=>{n.invalidateQueries({queryKey:["detalles-ventas","venta",r]}),n.invalidateQueries({queryKey:["ventas"]}),n.invalidateQueries({predicate:({queryKey:s})=>Array.isArray(s)&&s[0]==="reportes"})}}),y&&e.jsx(R,{ventaId:r,detalle:y,onClose:()=>u(null),onSaved:()=>{n.invalidateQueries({queryKey:["detalles-ventas","venta",r]}),n.invalidateQueries({queryKey:["ventas"]}),n.invalidateQueries({predicate:({queryKey:s})=>Array.isArray(s)&&s[0]==="reportes"})}})]})]}):null}function O(r){return Math.round((r+Number.EPSILON)*100)/100}function R({ventaId:r,detalle:l,onClose:p,onSaved:b}){const n=!!l,{data:c}=T({queryKey:["productos"],queryFn:W.getProductos,staleTime:12e4,refetchOnWindowFocus:!1}),[h,y]=i.useState(l?.productoId||(c?.[0]?.id??0)),[u,j]=i.useState(l?.cantidad||1),[N,k]=i.useState(l?.precioUnitario||(c?Number(c.find(t=>t.id===h)?.precio||0):0)),v=i.useMemo(()=>{if(!c)return N;const t=c.find(C=>C.id===h),s=Number(t?.precio||0);return n?N:s},[c,h,N,n]),w=i.useMemo(()=>O((Number(v)||0)*(Number(u)||0)),[v,u]),S=M({mutationFn:async t=>U.createDetalle(t),onSuccess:()=>{x.success("Detalle agregado"),b(),p()},onError:t=>{if(F(t)&&t.status===409){const s=t.json??null;if((typeof s?.code=="string"?s.code:void 0)==="stock_insuficiente"){const P=E=>{if(!s||!(E in s))return"N/D";const D=s[E];return typeof D=="number"?D.toString():typeof D=="string"?D:"N/D"};x.error(`Stock insuficiente: disponible ${P("disponible")}, solicitado ${P("solicitado")}`);return}}if(F(t)){x.error(t.message||"Error al crear");return}if(t instanceof Error){x.error(t.message);return}x.error("Error al crear")}}),g=M({mutationFn:async t=>U.updateDetalle(t.id,t.data),onSuccess:()=>{x.success("Detalle actualizado"),b(),p()},onError:t=>{if(F(t)&&t.status===409){const s=t.json??null;if((typeof s?.code=="string"?s.code:void 0)==="stock_insuficiente"){const P=E=>{if(!s||!(E in s))return"N/D";const D=s[E];return typeof D=="number"?D.toString():typeof D=="string"?D:"N/D"};x.error(`Stock insuficiente: disponible ${P("disponible")}, solicitado ${P("solicitado")}`);return}}if(F(t)){x.error(t.message||"Error al actualizar");return}if(t instanceof Error){x.error(t.message);return}x.error("Error al actualizar")}}),d=()=>r?!h||h<=0?"Producto inválido":!u||u<1||!Number.isInteger(Number(u))?"Cantidad debe ser entero >= 1":v<0?"Precio no puede ser negativo":w<0?"Subtotal inválido":"":"Venta no válida",m=t=>{t.preventDefault();const s=d();if(s)return x.error(s);const C={ventaId:r,productoId:Number(h),cantidad:Number(u),precioUnitario:O(Number(v)),subtotal:w};if(n&&l){const P={...C};g.mutate({id:l.id,data:P})}else S.mutate(C)};return e.jsx("div",{className:"fixed inset-0 z-[70] flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg shadow-xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b sticky top-0 bg-white z-10",children:[e.jsx("h3",{className:"text-lg font-semibold",children:n?"Editar detalle":"Agregar detalle"}),e.jsx("button",{onClick:p,className:"text-gray-500 hover:text-gray-700 text-2xl","aria-label":"Cerrar",children:"×"})]}),e.jsxs("form",{onSubmit:m,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Producto"}),e.jsx("select",{value:h,onChange:t=>y(Number(t.target.value)),className:"w-full px-3 py-2 border rounded-md bg-white",children:(c||[]).map(t=>e.jsx("option",{value:t.id,children:t.nombre},t.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cantidad"}),e.jsx("input",{type:"number",min:1,step:1,value:u,onChange:t=>j(Number(t.target.value)),className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio unitario"}),e.jsx("input",{type:"number",min:0,step:.01,value:v,onChange:t=>{const s=Number(t.target.value);k(s)},className:"w-full px-3 py-2 border rounded-md"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subtotal"}),e.jsx("input",{readOnly:!0,value:w,className:"w-full px-3 py-2 border rounded-md bg-gray-50"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:p,className:"px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700",children:n?"Guardar cambios":"Agregar"})]})]})]})})}const re=r=>new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(typeof r=="string"?Number(r):r),H={efectivo:"Efectivo",tarjeta:"Tarjeta",transferencia:"Transferencia",qr:"QR"},ce=()=>{const r=z(),[l,p]=i.useState(""),[b,n]=i.useState(""),[c,h]=i.useState(!1),[y,u]=i.useState(null),{data:j,isLoading:N,error:k,refetch:v,isFetching:w}=T({queryKey:["ventas"],queryFn:B.getVentas,staleTime:60*1e3,refetchOnWindowFocus:!1}),S=i.useMemo(()=>j??[],[j]),g=new Date().toLocaleDateString("en-CA"),d=i.useMemo(()=>S.filter(t=>t.fechaVenta?new Date(t.fechaVenta).toLocaleDateString("en-CA")===g:!1),[S,g]),m=i.useMemo(()=>d.filter(t=>[t.id,t.clienteNombre||"",t.notas||"",t.metodoPago,t.total].join(" ").toString().toLowerCase().includes(l.toLowerCase())).filter(t=>b?t.metodoPago===b:!0),[d,l,b]);return N?e.jsx("div",{className:"p-6 text-sm text-slate-500",children:"Cargando ventas..."}):k?e.jsx("div",{className:"rounded-2xl border border-red-200 bg-red-50 p-6 text-sm text-red-600",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("span",{children:["Error al cargar ventas: ",k.message]}),e.jsx("button",{onClick:()=>v(),className:"inline-flex items-center justify-center rounded-lg border border-red-200 bg-white px-3 py-1.5 text-xs font-semibold text-red-600 transition hover:bg-red-100",children:"Reintentar"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full space-y-7",children:[e.jsxs("div",{className:"flex flex-col gap-3 rounded-3xl border border-slate-200 bg-white p-5 shadow-sm sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-11 w-11 items-center justify-center rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 shadow-lg shadow-indigo-500/30",children:e.jsx("svg",{className:"h-6 w-6 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-slate-900",children:"Ventas de Hoy"}),e.jsxs("p",{className:"text-xs text-slate-500",children:[new Date().toLocaleDateString("es-BO",{day:"numeric",month:"short"})," · ",m.length," ",m.length===1?"transacción":"transacciones"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>v(),className:"inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 disabled:opacity-60",disabled:w,children:[e.jsx("svg",{className:`h-4 w-4 ${w?"animate-spin":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),w?"...":"Refrescar"]})})]}),e.jsxs("div",{className:"flex flex-col gap-3 rounded-3xl border border-slate-200 bg-white p-6 shadow-sm sm:flex-row sm:items-end sm:justify-between",children:[e.jsxs("div",{className:"w-full sm:max-w-sm",children:[e.jsx("label",{className:"block text-xs font-semibold uppercase tracking-[0.18em] text-slate-400",children:"Buscar"}),e.jsx("input",{value:l,onChange:t=>p(t.target.value),placeholder:"Cliente, notas o monto",className:"mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm shadow-sm focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-100"})]}),e.jsxs("div",{className:"w-full sm:max-w-xs",children:[e.jsx("label",{className:"block text-xs font-semibold uppercase tracking-[0.18em] text-slate-400",children:"Método de pago"}),e.jsxs("select",{value:b,onChange:t=>n(t.target.value||""),className:"mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-100",children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"efectivo",children:"Efectivo"}),e.jsx("option",{value:"tarjeta",children:"Tarjeta"}),e.jsx("option",{value:"transferencia",children:"Transferencia"}),e.jsx("option",{value:"qr",children:"QR"})]})]}),e.jsx("button",{onClick:()=>h(!0),className:"inline-flex items-center justify-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-700",children:"+ Nueva venta"})]}),e.jsx("div",{className:"overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm",children:e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-200",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Fecha"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Cliente"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Método"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Total"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Notas"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-[0.18em] text-slate-500",children:"Acciones"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 bg-white",children:m.map((t,s)=>e.jsxs("tr",{className:"transition hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-semibold text-slate-600",children:s+1}),e.jsx("td",{className:"px-4 py-3 text-sm text-slate-700",children:t.fechaVenta?new Date(t.fechaVenta).toLocaleString("es-BO",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-slate-700",children:t.clienteNombre||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("span",{className:"inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-600",children:H[t.metodoPago]})}),e.jsx("td",{className:"px-4 py-3 text-right text-sm font-semibold text-slate-900",children:re(t.total)}),e.jsx("td",{className:"px-4 py-3 text-sm text-slate-500",children:e.jsx("span",{className:"line-clamp-1",children:t.notas||""})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsx("button",{onClick:()=>u(t),className:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-semibold text-slate-600 transition hover:border-indigo-200 hover:bg-indigo-50 hover:text-indigo-600",children:"Ver detalles"})})]},t.id))})]})})}),m.length===0&&e.jsx("div",{className:"rounded-3xl border border-slate-200 bg-white p-8 text-center text-sm text-slate-500 shadow-sm",children:"No hay ventas para mostrar."})]}),e.jsx(te,{abierto:c,onCerrar:()=>h(!1)}),e.jsx(ae,{abierto:!!y,ventaId:y?.id||0,ventaInfo:{cliente:y?.clienteNombre??null,metodo:H[y?.metodoPago||"efectivo"],fecha:y?.fechaVenta??null,total:y?.total??null},onCerrar:()=>{u(null),r.invalidateQueries({queryKey:["ventas"]})}})]})};export{ce as default};
